package services

import (
	"archive/zip"
	"backend/config"
	"bytes"
	"errors"
	"fmt"
	"io"
	"mime/multipart"
	"os"
	"path/filepath"
)

func open_file(file *multipart.FileHeader) (*zip.Reader, error) {
	f, err := file.Open()
	if err != nil {
		return nil, err
	}
	defer f.Close()

	buf := new(bytes.Buffer)
	if _, err := io.Copy(buf, f); err != nil {
		return nil, err
	}

	zipReader, err := zip.NewReader(bytes.NewReader(buf.Bytes()), int64(buf.Len()))
	if err != nil {
		return nil, err
	}
	return zipReader, nil

}

func find_home(zipReader *zip.Reader) (*zip.File, error) {
	for _, zf := range zipReader.File {
		if zf.Name == "Home.xml" {
			fmt.Println("HOME FOUND!!")
			return zf, nil
			break
		}
	}
	return nil, errors.New("Not home found")

}
func save_home(zf *zip.File) error {
	rc, err := zf.Open()
	if err != nil {
		return err
	}

	fileBuf := new(bytes.Buffer)
	if _, err := io.Copy(fileBuf, rc); err != nil {
		rc.Close()
		return err
	}

	path := filepath.Join(config.ConfigPath, "home.xml")
	f, err := os.Create(path)
	if err != nil {
		return err
	}
	defer f.Close()

	if _, err := f.Write(fileBuf.Bytes()); err != nil {
		return err
	}
	f.Sync()
	rc.Close()

	return nil
}

func HandleUpload(file *multipart.FileHeader) error {
	sh3d, err := open_file(file)
	if err != nil {
		return err
	}

	homeFile, err := find_home(sh3d)
	if err := save_home(homeFile); err != nil {
		return err
	}

	return nil
}
